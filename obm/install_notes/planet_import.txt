#### PLANET UPLOADS NOTES ####

## Edit a couple parameters in postgresql.conf to performance tune the database
shared_buffers = 3000MB   # Set this to 25% of your total RAM 
Added "kernel.shmmax=3221159936" into /etc/sysct.conf to support the need for larger shared memory #This was tested first w/ command "sudo /sbin/sysctl -w kernel.shmmax=3221159936"
bgwriter_delay = 2000ms  # I don't know what a good value is, but since we're loading a lot of data, larger sounds better

## Uncomment last four last lines of default.style to create columns for extra attributes
## So they look like the following lines

"""
#The following entries can be used with the --extra-attributes option
# to include the username, userid, version & timstamp in the DB
node,way  osm_user       text
node,way  osm_uid        text
node,way  osm_version    text
node,way  osm_timestamp  text
"""

## Unzip bz2 and rezip as gzip for performance
## We never got this working. So it is still unresolved 
## to how much this will help
bzcat planet-latest.osm.bz2 | gzip > planet-latest.osm.gz

#### createdb and add intarry support ####
createdb -T template_postgis -O postgres planetimport
psql -d planetimport -f /usr/local/pgsql/share/contrib/_int.sql

#### import osm data as postgres user ####
# -su to postgres user
sudo -u -postgres -i -H
cd /mnt/z-raid6/gis/osm/extracts/planet_dumps/
# run osm2pgsql
osm2pgsql --slim -d planetimport -x -H localhost -P 5432 -C 3000 -S /usr/local/share/osm2pgsql/default.style planet-latest.osm.gzip


#### --appending planet daily diff files with osm2pgsql ####
# daily diffs are located in /mnt/z-raid6/gis/osmosis_working/daily_diffs
# everything in /mnt/z-raid6/gis/osmosis_working/ is valuable
# so here is a description of files in /mnt/z-raid6/gis/osmosis_working
1. configuration.txt, configuration.txt.bak, state.txt --> all related to osmosis workingspace configuration for getting minutely and hourly diffs
2. changes.osc.gz --> a zip file of changes that was probably pulled down from osmosis program
3. logs --> logs about osmosis program incorporating daily and hourly diffs
4. import_changes.sh --> a bash script showing how mkenny imported daily diffs into sfo test dataset
5. update-db.sh --> a bash script added to cronjob showing how mkenny got synched minutely updates using osmosis and osm2pgsql

# I commented out mkenny's daily diff runs in import_changes.sh 
# and created a new section to run planetimport daily diffs
# it looks like this:
"""
# osm2pgsql commands for applying daily and hourly diffs to planetimport from
DIFFDIR="/mnt/z-raid6/gis/osmosis_working/daily_diffs/"
SUFFIX="gz"

for diff in  "$DIFFDIR"/*.$SUFFIX
do
        osm2pgsql --append --slim -d planetimport -H localhost -P 5432 -C 3000 -S /usr/local/share/osm2pgsql/default.style $diff  
done
"""
